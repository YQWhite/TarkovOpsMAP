import{defineProperty as t}from"../../_virtual/_rollupPluginBabelHelpers.min.mjs";import{dragHandler as e}from"../controls/drag.min.mjs";import{getActionFromCorner as i}from"../controls/util.min.mjs";import{Point as r}from"../Point.min.mjs";import{FabricObject as s}from"../shapes/Object/FabricObject.min.mjs";import{saveObjectTransform as n,addTransformToObject as o}from"../util/misc/objectTransforms.min.mjs";import{StaticCanvas as c}from"./StaticCanvas.min.mjs";import{isCollection as a}from"../Collection.min.mjs";import{isTransparent as l}from"../util/misc/isTransparent.min.mjs";import{degreesToRadians as h}from"../util/misc/radiansDegreesConversion.min.mjs";import{isTouchEvent as m,getPointer as d}from"../util/dom_event.min.mjs";import{pick as g}from"../util/misc/pick.min.mjs";import{sendPointToPlane as u}from"../util/misc/planeChange.min.mjs";import{cos as p}from"../util/misc/cos.min.mjs";import{sin as f}from"../util/misc/sin.min.mjs";import"../util/misc/vectors.min.mjs";import"../util/misc/projectStroke/StrokeLineJoinProjections.min.mjs";import{SCALE as _,SCALE_X as v,SCALE_Y as b,RESIZING as j,ROTATE as T,RIGHT as x,LEFT as C,BOTTOM as O,TOP as y,CENTER as w,MODIFIED as S,SKEW_X as P,SKEW_Y as A}from"../constants.min.mjs";import"../config.min.mjs";import{createCanvasElement as D}from"../util/misc/dom.min.mjs";import"../shapes/Group.min.mjs";import"../cache.min.mjs";import"../parser/constants.min.mjs";import"../util/animation/AnimationRegistry.min.mjs";import{CanvasDOMManager as R}from"./DOMManagers/CanvasDOMManager.min.mjs";import{canvasDefaults as k}from"./CanvasOptions.min.mjs";import{Intersection as F}from"../Intersection.min.mjs";import{isActiveSelection as M}from"../util/typeAssertions.min.mjs";class E extends c{constructor(){super(...arguments),t(this,"_hoveredTargets",[]),t(this,"_currentTransform",null),t(this,"_groupSelector",null),t(this,"contextTopDirty",!1)}static getDefaults(){return{...super.getDefaults(),...E.ownDefaults}}get upperCanvasEl(){var t;return null===(t=this.elements.upper)||void 0===t?void 0:t.el}get contextTop(){var t;return null===(t=this.elements.upper)||void 0===t?void 0:t.ctx}get wrapperEl(){return this.elements.container}initElements(t){this.elements=new R(t,{allowTouchScrolling:this.allowTouchScrolling,containerClass:this.containerClass}),this._createCacheCanvas()}_onObjectAdded(t){this._objectsToRender=void 0,super._onObjectAdded(t)}_onObjectRemoved(t){this._objectsToRender=void 0,t===this._activeObject&&(this.fire("before:selection:cleared",{deselected:[t]}),this._discardActiveObject(),this.fire("selection:cleared",{deselected:[t]}),t.fire("deselected",{target:t})),t===this._hoveredTarget&&(this._hoveredTarget=void 0,this._hoveredTargets=[]),super._onObjectRemoved(t)}_onStackOrderChanged(){this._objectsToRender=void 0,super._onStackOrderChanged()}_chooseObjectsToRender(){const t=this._activeObject;return!this.preserveObjectStacking&&t?this._objects.filter(e=>!e.group&&e!==t).concat(t):this._objects}renderAll(){this.cancelRequestedRender(),this.destroyed||(!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1),!this._objectsToRender&&(this._objectsToRender=this._chooseObjectsToRender()),this.renderCanvas(this.getContext(),this._objectsToRender))}renderTopLayer(t){t.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(t),this.contextTopDirty=!0),t.restore()}renderTop(){const t=this.contextTop;this.clearContext(t),this.renderTopLayer(t),this.fire("after:render",{ctx:t})}setTargetFindTolerance(t){t=Math.round(t),this.targetFindTolerance=t;const e=this.getRetinaScaling(),i=Math.ceil((2*t+1)*e);this.pixelFindCanvasEl.width=this.pixelFindCanvasEl.height=i,this.pixelFindContext.scale(e,e)}isTargetTransparent(t,e,i){const r=this.targetFindTolerance,s=this.pixelFindContext;this.clearContext(s),s.save(),s.translate(-e+r,-i+r),s.transform(...this.viewportTransform);const n=t.selectionBackgroundColor;t.selectionBackgroundColor="",t.render(s),t.selectionBackgroundColor=n,s.restore();const o=Math.round(r*this.getRetinaScaling());return l(s,o,o,o)}_isSelectionKeyPressed(t){const e=this.selectionKey;return!!e&&(Array.isArray(e)?!!e.find(e=>!!e&&!0===t[e]):t[e])}_shouldClearSelection(t,e){const i=this.getActiveObjects(),r=this._activeObject;return!!(!e||e&&r&&i.length>1&&-1===i.indexOf(e)&&r!==e&&!this._isSelectionKeyPressed(t)||e&&!e.evented||e&&!e.selectable&&r&&r!==e)}_shouldCenterTransform(t,e,i){if(!t)return;let r;return e===_||e===v||e===b||e===j?r=this.centeredScaling||t.centeredScaling:e===T&&(r=this.centeredRotation||t.centeredRotation),r?!i:i}_getOriginFromCorner(t,e){const i={x:t.originX,y:t.originY};return e?(["ml","tl","bl"].includes(e)?i.x=x:["mr","tr","br"].includes(e)&&(i.x=C),["tl","mt","tr"].includes(e)?i.y=O:["bl","mb","br"].includes(e)&&(i.y=y),i):i}_setupCurrentTransform(t,r,s){var o;const c=r.group?u(this.getScenePoint(t),void 0,r.group.calcTransformMatrix()):this.getScenePoint(t),{key:a="",control:l}=r.getActiveControl()||{},m=s&&l?null===(o=l.getActionHandler(t,r,l))||void 0===o?void 0:o.bind(l):e,d=i(s,a,t,r),g=t[this.centeredKey],p=this._shouldCenterTransform(r,d,g)?{x:w,y:w}:this._getOriginFromCorner(r,a),f={target:r,action:d,actionHandler:m,actionPerformed:!1,corner:a,scaleX:r.scaleX,scaleY:r.scaleY,skewX:r.skewX,skewY:r.skewY,offsetX:c.x-r.left,offsetY:c.y-r.top,originX:p.x,originY:p.y,ex:c.x,ey:c.y,lastX:c.x,lastY:c.y,theta:h(r.angle),width:r.width,height:r.height,shiftKey:t.shiftKey,altKey:g,original:{...n(r),originX:p.x,originY:p.y}};this._currentTransform=f,this.fire("before:transform",{e:t,transform:f})}setCursor(t){this.upperCanvasEl.style.cursor=t}_drawSelection(t){const{x:e,y:i,deltaX:n,deltaY:o}=this._groupSelector,c=new r(e,i).transform(this.viewportTransform),a=new r(e+n,i+o).transform(this.viewportTransform),l=this.selectionLineWidth/2;let h=Math.min(c.x,a.x),m=Math.min(c.y,a.y),d=Math.max(c.x,a.x),g=Math.max(c.y,a.y);this.selectionColor&&(t.fillStyle=this.selectionColor,t.fillRect(h,m,d-h,g-m)),this.selectionLineWidth&&this.selectionBorderColor&&(t.lineWidth=this.selectionLineWidth,t.strokeStyle=this.selectionBorderColor,h+=l,m+=l,d-=l,g-=l,s.prototype._setLineDash.call(this,t,this.selectionDashArray),t.strokeRect(h,m,d-h,g-m))}findTarget(t){if(this._targetInfo)return this._targetInfo;if(this.skipTargetFind)return{subTargets:[],currentSubTargets:[]};const e=this.getScenePoint(t),i=this._activeObject,r=this.getActiveObjects(),s=this.searchPossibleTargets(this._objects,e),{subTargets:n,container:o,target:c}=s,a={...s,currentSubTargets:n,currentContainer:o,currentTarget:c};if(!i)return a;const l={...this.searchPossibleTargets([i],e),currentSubTargets:n,currentContainer:o,currentTarget:c};if(i.findControl(this.getViewportPoint(t),m(t)))return{...l,target:i};if(l.target){if(r.length>1)return l;if(!this.preserveObjectStacking)return l;if(this.preserveObjectStacking&&t[this.altSelectionKey])return l}return a}_pointIsInObjectSelectionArea(t,e){let i=t.getCoords();const s=this.getZoom(),n=t.padding/s;if(n){const[t,e,s,o]=i,c=Math.atan2(e.y-t.y,e.x-t.x),a=p(c)*n,l=f(c)*n,h=a+l,m=a-l;i=[new r(t.x-m,t.y-h),new r(e.x+h,e.y-m),new r(s.x+m,s.y+h),new r(o.x-h,o.y+m)]}return F.isPointInPolygon(e,i)}_checkTarget(t,e){if(t&&t.visible&&t.evented&&this._pointIsInObjectSelectionArea(t,e)){if(!this.perPixelTargetFind&&!t.perPixelTargetFind||t.isEditing)return!0;{const i=e.transform(this.viewportTransform);if(!this.isTargetTransparent(t,i.x,i.y))return!0}}return!1}_searchPossibleTargets(t,e,i){let r=t.length;for(;r--;){const s=t[r];if(this._checkTarget(s,e)){if(a(s)&&s.subTargetCheck){const{target:t}=this._searchPossibleTargets(s._objects,e,i);t&&i.push(t)}return{target:s,subTargets:i}}}return{subTargets:[]}}searchPossibleTargets(t,e){const i=this._searchPossibleTargets(t,e,[]);i.container=i.target;const{container:r,subTargets:s}=i;if(r&&a(r)&&r.interactive&&s[0]){for(let t=s.length-1;t>0;t--){const e=s[t];if(!a(e)||!e.interactive)return i.target=e,i}return i.target=s[0],i}return i}getViewportPoint(t){return this._viewportPoint?this._viewportPoint:this._getPointerImpl(t,!0)}getScenePoint(t){return this._scenePoint?this._scenePoint:this._getPointerImpl(t)}_getPointerImpl(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=this.upperCanvasEl,s=i.getBoundingClientRect();let n=d(t),o=s.width||0,c=s.height||0;o&&c||(y in s&&O in s&&(c=Math.abs(s.top-s.bottom)),x in s&&C in s&&(o=Math.abs(s.right-s.left))),this.calcOffset(),n.x=n.x-this._offset.left,n.y=n.y-this._offset.top,e||(n=u(n,void 0,this.viewportTransform));const a=this.getRetinaScaling();1!==a&&(n.x/=a,n.y/=a);const l=0===o||0===c?new r(1,1):new r(i.width/o,i.height/c);return n.multiply(l)}_setDimensionsImpl(t,e){this._resetTransformEventData(),super._setDimensionsImpl(t,e),this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop)}_createCacheCanvas(){this.pixelFindCanvasEl=D(),this.pixelFindContext=this.pixelFindCanvasEl.getContext("2d",{willReadFrequently:!0}),this.setTargetFindTolerance(this.targetFindTolerance)}getTopContext(){return this.elements.upper.ctx}getSelectionContext(){return this.elements.upper.ctx}getSelectionElement(){return this.elements.upper.el}getActiveObject(){return this._activeObject}getActiveObjects(){const t=this._activeObject;return M(t)?t.getObjects():t?[t]:[]}_fireSelectionEvents(t,e){let i=!1,r=!1;const s=this.getActiveObjects(),n=[],o=[];t.forEach(t=>{s.includes(t)||(i=!0,t.fire("deselected",{e:e,target:t}),o.push(t))}),s.forEach(r=>{t.includes(r)||(i=!0,r.fire("selected",{e:e,target:r}),n.push(r))}),t.length>0&&s.length>0?(r=!0,i&&this.fire("selection:updated",{e:e,selected:n,deselected:o})):s.length>0?(r=!0,this.fire("selection:created",{e:e,selected:n})):t.length>0&&(r=!0,this.fire("selection:cleared",{e:e,deselected:o})),r&&(this._objectsToRender=void 0)}setActiveObject(t,e){const i=this.getActiveObjects(),r=this._setActiveObject(t,e);return this._fireSelectionEvents(i,e),r}_setActiveObject(t,e){const i=this._activeObject;return i!==t&&(!(!this._discardActiveObject(e,t)&&this._activeObject)&&(!t.onSelect({e:e})&&(this._activeObject=t,M(t)&&i!==t&&t.set("canvas",this),t.setCoords(),!0)))}_discardActiveObject(t,e){const i=this._activeObject;return!!i&&(!i.onDeselect({e:t,object:e})&&(this._currentTransform&&this._currentTransform.target===i&&this.endCurrentTransform(t),M(i)&&i===this._hoveredTarget&&(this._hoveredTarget=void 0),this._activeObject=void 0,!0))}discardActiveObject(t){const e=this.getActiveObjects(),i=this.getActiveObject();e.length&&this.fire("before:selection:cleared",{e:t,deselected:[i]});const r=this._discardActiveObject(t);return this._fireSelectionEvents(e,t),r}endCurrentTransform(t){const e=this._currentTransform;this._finalizeCurrentTransform(t),e&&e.target&&(e.target.isMoving=!1),this._currentTransform=null}_finalizeCurrentTransform(t){const e=this._currentTransform,i=e.target,r={e:t,target:i,transform:e,action:e.action};i._scaling&&(i._scaling=!1),i.setCoords(),e.actionPerformed&&(this.fire("object:modified",r),i.fire(S,r))}setViewportTransform(t){super.setViewportTransform(t);const e=this._activeObject;e&&e.setCoords()}destroy(){const t=this._activeObject;M(t)&&(t.removeAll(),t.dispose()),delete this._activeObject,super.destroy(),this.pixelFindContext=null,this.pixelFindCanvasEl=void 0}clear(){this.discardActiveObject(),this._activeObject=void 0,this.clearContext(this.contextTop),super.clear()}drawControls(t){const e=this._activeObject;e&&e._renderControls(t)}_toObject(t,e,i){const r=this._realizeGroupTransformOnObject(t),s=super._toObject(t,e,i);return t.set(r),s}_realizeGroupTransformOnObject(t){const{group:e}=t;if(e&&M(e)&&this._activeObject===e){const i=g(t,["angle","flipX","flipY",C,v,b,P,A,y]);return o(t,e.calcOwnMatrix()),i}return{}}_setSVGObject(t,e,i){const r=this._realizeGroupTransformOnObject(e);super._setSVGObject(t,e,i),e.set(r)}}t(E,"ownDefaults",k);export{E as SelectableCanvas};
//# sourceMappingURL=SelectableCanvas.min.mjs.map
